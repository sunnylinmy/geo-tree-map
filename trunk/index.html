<!DOCTYPE HTML>
<html>
  <head>
    <!-- Set the character encoding -->
    <meta charset="UTF-8">
    
    <!-- CSS -->
    <link type="text/css" rel="stylesheet" href="style.css" />
    
    <!-- Javascript -->
    <script type="text/javascript" src="scripts/protovis-r3.2.js"></script>
    <script type="text/javascript" src="scripts/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="scripts/centroid.js"></script>
    <script type="text/javascript" src="scripts/us_lowres.js"></script>  
    <script type="text/javascript" src="scripts/popupDiv.js"></script>
    <script type="text/javascript" src="stateOccupationData.js"></script>
    <script type="text/javascript" src="scripts/titleDescription.js"></script>    
    
    <!-- Title -->
    <title>Geo Tree Map</title>
    
  </head>
  <body>
    <!-- Data on demand popup window -->
    <div id="popupData">
      <span id="close"><a href="javascript:setVisible('popupData', null)">Hide</a></span>
      <div id="dataDiv"></div>
    </div>
    <div id="titleDescription"></div>
    <!-- Protovis rendering -->
    <div id="fig">
    <script type="text/javascript">
    
var majorCategory = "Management occupations",
    minorCategory = null,
    measure = "total";

var w = 910,
    h = 400,
    measureMaxVal = 0,
    measureMinVal = 0,
    level = 2;

var scale = pv.Geo.scale()
    .domain({lng: -128, lat: 24}, {lng: -64, lat: 50})
    .range({x: 0, y: 0}, {x: w, y: h});

function findMaxMinValue(majorCategory, minorCategory, measure) {
  measureMaxVal = -1;
  measureMinVal = 1000000000000;
  var levelOccupationData = stateOccupationData[measure + "_" + level];
  
  for (var key in levelOccupationData) {
    var arrVal = levelOccupationData[key];
    if (majorCategory != null && majorCategory != "") {
      arrVal = arrVal[majorCategory];
    }
    if (minorCategory != null && minorCategory != "") {
      arrVal = arrVal[minorCategory];
    }

    if (arrVal > measureMaxVal && arrVal >= 0) {
      measureMaxVal = arrVal
    }
    if (arrVal < measureMinVal && arrVal >= 0) {
      measureMinVal = arrVal
    }
  }
}

setTitleDescription("titleDescription", measure);

function getStateValue(stateCode, majorCategory, minorCategory, measure) {
	  var arrVal = stateOccupationData[measure + "_" + level];
	  var arrVal = arrVal[stateCode];
	  if (majorCategory != null && majorCategory != "") {
	    arrVal = arrVal[majorCategory];
	  }
	  if (minorCategory != null && minorCategory != "") {
	    arrVal = arrVal[minorCategory];
	  }
	  
	  return arrVal;
}

findMaxMinValue(majorCategory, minorCategory, measure);

var intervalScale = parseInt((measureMaxVal - measureMinVal)/5);    
var color = pv.Scale.linear(measureMinVal, measureMaxVal,(measureMaxVal - measureMinVal)/10).range("lightgreen", "forestgreen");

// Find the centroid for each state
us_lowres.forEach(function(c) {
  c.code = c.code.toUpperCase();
  c.centLatLon = centroid(c.borders[0]);
});


// Add the main panel
var vis = new pv.Panel()
    .width(w)
    .height(h)
    .top(30)
    .bottom(20);

// Add a panel for each state
var state = vis.add(pv.Panel)
    .data(us_lowres);

// Add a panel for each state land mass
state.add(pv.Panel)
    .data(function(c) { return c.borders })
  .add(pv.Line)
    .data(function(l) { return l })
    .left(scale.x)
    .top(scale.y)
    .fillStyle(function(d, l, c) { return color(getStateValue(c.code, majorCategory, minorCategory, measure)) })
    .lineWidth(1)
    .strokeStyle("white")
    .antialias(false)
    .event("mouseover", function(d,l,c) { this.fillStyle("blue"); return this; } )
	.event("mouseout", function(d, l, c) {  this.fillStyle(color(getStateValue(c.code, majorCategory, minorCategory, measure))); return this;} )
    .event("click", function(d,l,c) { setVisible('popupData', c.code); return this; } );

//Add a label with the state code in the middle of every state
vis.add(pv.Label)
    .data(us_lowres)
    .left(function(c) { return scale(c.centLatLon).x })
    .top(function(c) { return scale(c.centLatLon).y })
    .text(function(c) { return c.code })
    .textAlign("center")
    .textBaseline("middle");

// Add the color bars for the color legend
vis.add(pv.Bar)
    .data(pv.range(measureMinVal, measureMaxVal, intervalScale))
    .bottom(function(d) { return this.index * 12 + 40 })
    .height(10)
    .width(10)
    .left(w-100)
    .fillStyle(function(d) { return color(measureMinVal + intervalScale * this.index) })
    .lineWidth(null)
  .anchor("right").add(pv.Label)
    .textAlign("left")
    .text(function(d) { return d + " - " + (d + intervalScale) + "" });

/* The line. */
vis.add(pv.Line)
    .left(300)
    .bottom(300)
    .lineWidth(3);


vis.render();

      </script>
    </div>
  </body>
</html>
